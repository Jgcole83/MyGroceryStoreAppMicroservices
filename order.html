<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jessy's Grocery Outlet - Order</title>
    <link rel="stylesheet" href="order.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="background-container">
        <div class="overlay"></div>
    </div>

    <div class="main-container">
        <header>
            <div class="logo-container">
                <h1>Jessy's Grocery Outlet</h1>
                <p class="tagline">Fresh Groceries, Delivered to Your Doorstep</p>
            </div>
            <div class="header-actions">
                <div class="cart-container">
                    <button id="cart-toggle" class="cart-button">
                        <i class="fas fa-shopping-cart"></i>
                        <span id="cart-count">0</span>
                    </button>
                    <div id="cart-dropdown" class="cart-dropdown">
                        <div class="cart-header">
                            <h3>Your Cart</h3>
                            <button class="close-cart"><i class="fas fa-times"></i></button>
                        </div>
                        <div id="cart-items" class="cart-items"></div>
                        <div class="cart-footer">
                            <div class="cart-total">
                                <span>Total:</span>
                                <span id="cart-total-amount">$0.00</span>
                            </div>
                            <button id="checkout" class="checkout-button">
                                <i class="fas fa-lock"></i>
                                Checkout
                            </button>
                        </div>
                    </div>
                </div>
                <button id="login" class="login-button">
                    <i class="fas fa-sign-in-alt"></i>
                    Login
                </button>
                <button id="register" class="register-button">
                    <i class="fas fa-user-plus"></i>
                    Register
                </button>
            </div>
        </header>

        <main>
            <div id="error-message" class="error"></div>
            
            <!-- Search and Filter Section -->
            <div class="search-filter-container">
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="Search products...">
                    <button id="search-button">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div class="filter-options">
                    <div class="filter-group">
                        <label for="category-filter">Category:</label>
                        <select id="category-filter">
                            <option value="all">All Categories</option>
                            <option value="Dairy">Dairy</option>
                            <option value="Produce">Produce</option>
                            <option value="Meat">Meat</option>
                            <option value="Dry Goods">Dry Goods</option>
                            <option value="Bakery">Bakery</option>
                            <option value="Beverages">Beverages</option>
                            <option value="Snacks">Snacks</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="price-filter">Price Range:</label>
                        <select id="price-filter">
                            <option value="all">All Prices</option>
                            <option value="0-10">$0 - $10</option>
                            <option value="10-20">$10 - $20</option>
                            <option value="20-50">$20 - $50</option>
                            <option value="50+">$50+</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="sort-by">Sort By:</label>
                        <select id="sort-by">
                            <option value="name-asc">Name (A-Z)</option>
                            <option value="name-desc">Name (Z-A)</option>
                            <option value="price-asc">Price (Low to High)</option>
                            <option value="price-desc">Price (High to Low)</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="categories-container">
                <div id="grocery-items" class="grocery-items"></div>
            </div>
            <div class="order-summary">
                <div class="order-total">
                    <span>Total:</span>
                    <span id="order-total-amount">$0.00</span>
                </div>
                <button id="submit-order" class="submit-order-button">Submit Order</button>
            </div>
        </main>

        <footer>
            <div class="footer-content">
                <div class="footer-section">
                    <h4>About Us</h4>
                    <p>Your trusted source for fresh, quality groceries at competitive prices.</p>
                </div>
                <div class="footer-section">
                    <h4>Contact</h4>
                    <p>Email: info@jessysgrocery.com</p>
                    <p>Phone: (555) 123-4567</p>
                </div>
                <div class="footer-section">
                    <h4>Follow Us</h4>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>Â© 2024 Jessy's Grocery Outlet. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <!-- Guest Checkout Modal -->
    <div id="guest-checkout-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-modal" id="close-guest-modal">&times;</span>
            <h2>Guest Checkout</h2>
            <form id="guest-checkout-form">
                <div class="form-group">
                    <label for="guest-name">Name</label>
                    <input type="text" id="guest-name" name="guest-name" required>
                </div>
                <div class="form-group">
                    <label for="guest-email">Email</label>
                    <input type="email" id="guest-email" name="guest-email" required>
                </div>
                <div class="form-group">
                    <label for="guest-address">Address</label>
                    <input type="text" id="guest-address" name="guest-address" required>
                </div>
                <div class="form-group">
                    <label for="guest-city">City</label>
                    <input type="text" id="guest-city" name="guest-city" required>
                </div>
                <div class="form-group">
                    <label for="guest-state">State</label>
                    <input type="text" id="guest-state" name="guest-state" required>
                </div>
                <div class="form-group">
                    <label for="guest-phone">Phone</label>
                    <input type="text" id="guest-phone" name="guest-phone" required>
                </div>
                <button type="submit" class="checkout-button">Place Order as Guest</button>
            </form>
        </div>
    </div>

    <script>
        // Cart implementation
        const cart = {
            items: [],
            total: 0,

            addItem: function(productId, name, price) {
                const existingItem = this.items.find(item => item.id === productId);
                if (existingItem) {
                    existingItem.quantity++;
                } else {
                    this.items.push({
                        id: productId,
                        name: name,
                        price: price,
                        quantity: 1
                    });
                }
                this.calculateTotal();
                this.updateCartDisplay();
            },

            removeItem: function(productId) {
                this.items = this.items.filter(item => item.id !== productId);
                this.calculateTotal();
                this.updateCartDisplay();
            },

            calculateTotal: function() {
                this.total = this.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                this.updateOrderTotal();
            },

            updateCartDisplay: function() {
                const cartItems = document.getElementById('cart-items');
                const cartCount = document.getElementById('cart-count');
                const cartTotal = document.getElementById('cart-total-amount');
                
                if (cartItems) {
                    cartItems.innerHTML = this.items.map(item => `
                        <div class="cart-item">
                            <div class="cart-item-info">
                                <span class="item-name">${item.name}</span>
                                <span class="item-quantity">Qty: ${item.quantity}</span>
                            </div>
                            <div class="cart-item-actions">
                                <span class="item-total">$${(item.price * item.quantity).toFixed(2)}</span>
                                <button onclick="cart.removeItem('${item.id}')" class="remove-item">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `).join('');
                }

                if (cartCount) {
                    cartCount.textContent = this.items.reduce((sum, item) => sum + item.quantity, 0);
                }

                if (cartTotal) {
                    cartTotal.textContent = `$${this.total.toFixed(2)}`;
                }
            },

            updateOrderTotal: function() {
                const orderTotal = document.getElementById('order-total-amount');
                if (orderTotal) {
                    orderTotal.textContent = `$${this.total.toFixed(2)}`;
                }
            },

            clear: function() {
                this.items = [];
                this.total = 0;
                this.updateCartDisplay();
            }
        };

        // Add to cart function
        function addToCart(productId, name, price) {
            cart.addItem(productId, name, price);
            
            // Show cart dropdown
            const cartDropdown = document.getElementById('cart-dropdown');
            if (cartDropdown) {
                cartDropdown.style.display = 'block';
            }
        }

        // Cart toggle functionality
        document.getElementById('cart-toggle').addEventListener('click', () => {
            const cartDropdown = document.getElementById('cart-dropdown');
            if (cartDropdown) {
                cartDropdown.style.display = cartDropdown.style.display === 'none' ? 'block' : 'none';
            }
        });

        // Close cart button
        document.querySelector('.close-cart').addEventListener('click', () => {
            const cartDropdown = document.getElementById('cart-dropdown');
            if (cartDropdown) {
                cartDropdown.style.display = 'none';
            }
        });

        // Submit order button
        document.getElementById('submit-order').addEventListener('click', () => {
            if (cart.items.length === 0) {
                alert('Your cart is empty. Please add some items before submitting your order.');
                return;
            }
            
            const token = localStorage.getItem('token');
            if (token) {
                handleCheckout(token);
            } else {
                document.getElementById('guest-checkout-modal').style.display = 'block';
            }
        });

        // Load products
        async function loadProducts() {
            try {
                const response = await fetch('http://localhost:3000/api/grocery-items');
                if (!response.ok) {
                    throw new Error('Failed to load products');
                }
                const data = await response.json();
                
                if (data.success && data.data) {
                    const groceryItemsContainer = document.getElementById('grocery-items');
                    groceryItemsContainer.innerHTML = ''; // Clear existing content
                    
                    // Create category sections for each category in data.data
                    for (const [category, products] of Object.entries(data.data)) {
                        const categorySection = document.createElement('div');
                        categorySection.className = 'category-section';
                        categorySection.innerHTML = `
                            <h2 class="category-title">${category}</h2>
                            <div class="product-grid">
                                ${products.map(product => `
                                    <div class="product-card">
                                        <div class="product-info">
                                            <h3>${product.name}</h3>
                                            <p class="price">$${product.price.toFixed(2)}</p>
                                            <p class="description">${product.description}</p>
                                        </div>
                                        <div class="product-actions">
                                            <button class="add-to-cart" onclick="addToCart('${product.id}', '${product.name}', ${product.price})">
                                                Add to Cart
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        groceryItemsContainer.appendChild(categorySection);
                    }
                } else {
                    throw new Error('Invalid data format received');
                }
            } catch (error) {
                console.error('Error loading products:', error);
                const groceryItemsContainer = document.getElementById('grocery-items');
                groceryItemsContainer.innerHTML = `
                    <div class="error-message">
                        <p>Failed to load products. Please try again later.</p>
                        <button onclick="loadProducts()">Retry</button>
                    </div>
                `;
            }
        }

        // Add event listeners for filters
        document.getElementById('category-filter').addEventListener('change', filterProducts);
        document.getElementById('price-filter').addEventListener('change', filterProducts);
        document.getElementById('sort-by').addEventListener('change', filterProducts);
        document.getElementById('search-input').addEventListener('input', filterProducts);

        // Function to filter and sort products
        async function filterProducts() {
            try {
                const response = await fetch('http://localhost:3000/api/grocery-items');
                if (!response.ok) throw new Error('Failed to fetch products');
                
                const result = await response.json();
                if (!result.success) throw new Error(result.message);

                const products = result.data;
                const categoryFilter = document.getElementById('category-filter').value;
                const priceFilter = document.getElementById('price-filter').value;
                const searchQuery = document.getElementById('search-input').value.toLowerCase();
                const sortBy = document.getElementById('sort-by').value;

                // Flatten all products into a single array
                let allProducts = [];
                Object.entries(products).forEach(([category, items]) => {
                    items.forEach(item => {
                        allProducts.push({
                            ...item,
                            category: category
                        });
                    });
                });

                // Apply filters
                let filteredProducts = allProducts.filter(product => {
                    // Category filter
                    if (categoryFilter !== 'all' && product.category !== categoryFilter) {
                        return false;
                    }

                    // Price filter
                    if (priceFilter !== 'all') {
                        const [min, max] = priceFilter.split('-').map(Number);
                        if (max) {
                            if (product.price < min || product.price > max) return false;
                        } else {
                            if (product.price < min) return false;
                        }
                    }

                    // Search filter
                    if (searchQuery) {
                        if (!product.name.toLowerCase().includes(searchQuery) && 
                            !product.description.toLowerCase().includes(searchQuery)) {
                            return false;
                        }
                    }

                    return true;
                });

                // Apply sorting
                filteredProducts.sort((a, b) => {
                    switch (sortBy) {
                        case 'name-asc':
                            return a.name.localeCompare(b.name);
                        case 'name-desc':
                            return b.name.localeCompare(a.name);
                        case 'price-asc':
                            return a.price - b.price;
                        case 'price-desc':
                            return b.price - a.price;
                        default:
                            return 0;
                    }
                });

                // Group filtered products by category
                const groupedProducts = filteredProducts.reduce((acc, product) => {
                    if (!acc[product.category]) acc[product.category] = [];
                    acc[product.category].push(product);
                    return acc;
                }, {});

                // Display filtered and sorted products
                const productList = document.getElementById('grocery-items');
                if (productList) {
                    productList.innerHTML = Object.entries(groupedProducts)
                        .filter(([_, items]) => items.length > 0)
                        .map(([category, items]) => `
                            <div class="category-section">
                                <h2 class="category-title">${category}</h2>
                                <div class="product-grid">
                                    ${items.map(item => `
                                        <div class="product-card">
                                            <div class="product-info">
                                                <h3>${item.name}</h3>
                                                <p class="price">$${item.price.toFixed(2)}</p>
                                                <p class="description">${item.description}</p>
                                            </div>
                                            <div class="product-actions">
                                                <button class="add-to-cart" onclick="addToCart('${item.id}', '${item.name}', ${item.price})">
                                                    Add to Cart
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('');
                }
            } catch (error) {
                console.error('Error filtering products:', error);
            }
        }

        // Load products on page load
        document.addEventListener('DOMContentLoaded', loadProducts);

        // Add event listeners for login and register buttons
        document.getElementById('login').addEventListener('click', () => {
            window.location.href = '/login.html';
        });

        document.getElementById('register').addEventListener('click', () => {
            // Check if we're already on the register page
            if (window.location.pathname.includes('register.html')) {
                return;
            }
            
            // Check if register.html exists
            fetch('/register.html')
                .then(response => {
                    if (response.ok) {
                        window.location.href = '/register.html';
                    } else {
                        // If register.html doesn't exist, show a modal
                        const registerModal = document.createElement('div');
                        registerModal.className = 'modal';
                        registerModal.innerHTML = `
                            <div class="modal-content">
                                <span class="close-modal">&times;</span>
                                <h2>Registration</h2>
                                <form id="register-form">
                                    <div class="form-group">
                                        <label for="register-name">Name</label>
                                        <input type="text" id="register-name" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="register-email">Email</label>
                                        <input type="email" id="register-email" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="register-password">Password</label>
                                        <input type="password" id="register-password" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="register-confirm-password">Confirm Password</label>
                                        <input type="password" id="register-confirm-password" required>
                                    </div>
                                    <button type="submit" class="submit-button">Register</button>
                                </form>
                            </div>
                        `;
                        document.body.appendChild(registerModal);
                        registerModal.style.display = 'block';

                        // Close modal when clicking the X
                        registerModal.querySelector('.close-modal').onclick = function() {
                            registerModal.style.display = 'none';
                        };

                        // Close modal when clicking outside
                        window.onclick = function(event) {
                            if (event.target == registerModal) {
                                registerModal.style.display = 'none';
                            }
                        };

                        // Handle form submission
                        document.getElementById('register-form').addEventListener('submit', async function(e) {
                            e.preventDefault();
                            
                            const name = document.getElementById('register-name').value;
                            const email = document.getElementById('register-email').value;
                            const password = document.getElementById('register-password').value;
                            const confirmPassword = document.getElementById('register-confirm-password').value;

                            if (password !== confirmPassword) {
                                alert('Passwords do not match!');
                                return;
                            }

                            try {
                                const response = await fetch('http://localhost:5500/auth/register', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        name,
                                        email,
                                        password
                                    })
                                });

                                if (response.ok) {
                                    const data = await response.json();
                                    alert('Registration successful! Please login.');
                                    registerModal.style.display = 'none';
                                    window.location.href = '/login.html';
                                } else {
                                    const error = await response.json();
                                    alert(error.message || 'Registration failed. Please try again.');
                                }
                            } catch (error) {
                                console.error('Registration error:', error);
                                alert('An error occurred during registration. Please try again.');
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error('Error checking register page:', error);
                    alert('An error occurred. Please try again.');
                });
        });

        // Modal logic for guest checkout
        const guestModal = document.getElementById('guest-checkout-modal');
        const closeGuestModal = document.getElementById('close-guest-modal');
        const guestCheckoutForm = document.getElementById('guest-checkout-form');
        document.getElementById('checkout').addEventListener('click', () => {
            const token = localStorage.getItem('token');
            if (token) {
                handleCheckout(token);
            } else {
                guestModal.style.display = 'block';
            }
        });
        closeGuestModal.onclick = function() {
            guestModal.style.display = 'none';
        };
        window.onclick = function(event) {
            if (event.target == guestModal) {
                guestModal.style.display = 'none';
            }
        };
        guestCheckoutForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const items = cart.getItems();
            if (items.length === 0) {
                alert('Your cart is empty. Please add some items.');
                return;
            }
            const guestData = {
                name: document.getElementById('guest-name').value,
                email: document.getElementById('guest-email').value,
                address: document.getElementById('guest-address').value,
                city: document.getElementById('guest-city').value,
                state: document.getElementById('guest-state').value,
                phone: document.getElementById('guest-phone').value,
                items: items,
                total: cart.total
            };
            try {
                const response = await fetch('http://localhost:5500/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(guestData)
                });
                if (response.ok) {
                    alert('Order placed successfully as a guest!');
                    cart.clear();
                    updateCartDisplay();
                    guestModal.style.display = 'none';
                } else {
                    alert('Error placing order. Please try again.');
                }
            } catch (error) {
                console.error('Error placing order:', error);
                alert('Error placing the order. Please try again later.');
            }
        });
        async function handleCheckout(token) {
            // Existing checkout logic for logged-in users
        }
    </script>
</body>
</html>